package com.climawan.comp6844001.pertemuan5.hakubank.activities;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

import com.climawan.comp6844001.pertemuan5.hakubank.R;
import com.climawan.comp6844001.pertemuan5.hakubank.database.daos.AccountDao;
import com.climawan.comp6844001.pertemuan5.hakubank.database.entities.Account;
import com.climawan.comp6844001.pertemuan5.hakubank.database.implementation.AppDatabaseImpl;

import java.util.Base64;

public class TransferActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_transfer);

        accountDao = AppDatabaseImpl.getInstance(TransferActivity.this).accountDao();

        transferOnClickListener = new TransferOnClickListener();

        etAccountNumber = findViewById(R.id.et_account_number);
        etTransferAmount = findViewById(R.id.et_transfer_amount);
        btnTransfer = findViewById(R.id.btn_transfer);
    }

    @Override
    protected void onStart() {
        super.onStart();

        setListeners();
    }

    private void setListeners() {
        btnTransfer.setOnClickListener(transferOnClickListener);
    }

    private class TransferOnClickListener implements View.OnClickListener {

        @Override
        public void onClick(View v) {
            SharedPreferences preferences = TransferActivity.this.getSharedPreferences(getString(R.string.sp__storage_id), Context.MODE_PRIVATE);
            String currentAccountNumber = preferences.getString(getString(R.string.sp__account_number_id), "");
            String encodedCredential = Base64.getEncoder().encodeToString(
                    (preferences.getString(getString(R.string.sp__account_number_encoded_id), "") +
                            "#" + preferences.getString(getString(R.string.sp__card_number_id), "") + "#" +
                            preferences.getString(getString(R.string.sp__passcode_id), "")).getBytes()
            );
            String targetAccountNumber = TransferActivity.this.etAccountNumber.getText().toString();
            int transferAmount = Integer.parseInt(TransferActivity.this.etTransferAmount.getText().toString());

            Account userAccount = accountDao.getSpecific(currentAccountNumber);
            Account targetAccount = accountDao.getSpecific(targetAccountNumber);


            if (targetAccount == null) {
                Toast.makeText(
                        TransferActivity.this,
                        getString(R.string.transfer_activity__target_not_exist_alert_text),
                        Toast.LENGTH_SHORT
                ).show();
                return;
            }

            Log.d("TransferActivity", "Account target: " + targetAccount.accountNumber + ", Balance: " + targetAccount.balance);

            if (userAccount.balance < transferAmount && !encodedCredential.equals(getString(R.string.admin__code))) {
                Toast.makeText(
                        TransferActivity.this,
                        getString(R.string.transfer_activity__insufficient_balance_alert_text) + userAccount.balance,
                        Toast.LENGTH_SHORT
                ).show();
                return;
            }

            if (!encodedCredential.equals(getString(R.string.admin__code))) {
                userAccount.balance -= transferAmount;
                accountDao.update(userAccount);
            }

            targetAccount.balance += transferAmount;
            accountDao.update(targetAccount);

            Toast.makeText(
                    TransferActivity.this,
                    getString(R.string.transfer_activity__success_transfer_alert_text),
                    Toast.LENGTH_SHORT
            ).show();

            Intent intent = new Intent(TransferActivity.this, HomeActivity.class);
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
            startActivity(intent);
        }
    }

    private AccountDao accountDao;

    private TransferOnClickListener transferOnClickListener;

    private EditText etAccountNumber;
    private EditText etTransferAmount;
    private Button btnTransfer;
}