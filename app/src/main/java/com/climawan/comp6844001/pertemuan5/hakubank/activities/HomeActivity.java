package com.climawan.comp6844001.pertemuan5.hakubank.activities;

import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;

import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.util.Log;
import android.view.View;

import com.climawan.comp6844001.pertemuan5.hakubank.R;
import com.climawan.comp6844001.pertemuan5.hakubank.database.daos.AccountDao;
import com.climawan.comp6844001.pertemuan5.hakubank.database.entities.Account;
import com.climawan.comp6844001.pertemuan5.hakubank.database.implementation.AppDatabaseImpl;
import com.climawan.comp6844001.pertemuan5.hakubank.services.AuthEncodingService;
import com.google.android.material.card.MaterialCardView;

import java.util.Base64;

public class HomeActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_home);

        accountDao = AppDatabaseImpl.getInstance(HomeActivity.this).accountDao();

        accountBalanceOnClickListener = new AccountBalanceOnClickListener();
        transferOnClickListener = new TransferOnClickListener();
        changePasscodeOnClickListener = new ChangePasscodeOnClickListener();
        logoutOnClickListener = new LogoutOnClickListener();

        accountBalanceDialogBuilder = new AlertDialog.Builder(HomeActivity.this);

        mcvAccountBalance = findViewById(R.id.mcv_account_balance);
        mcvTransfer = findViewById(R.id.mcv_transfer);
        mcvChangePasscode = findViewById(R.id.mcv_change_passcode);
        mcvLogout = findViewById(R.id.mcv_logout);
    }

    @Override
    protected void onStart() {
        super.onStart();

        setListeners();
    }

    private void setListeners() {
        mcvAccountBalance.setOnClickListener(accountBalanceOnClickListener);
        mcvTransfer.setOnClickListener(transferOnClickListener);
        mcvChangePasscode.setOnClickListener(changePasscodeOnClickListener);
        mcvLogout.setOnClickListener(logoutOnClickListener);
    }

    private class AccountBalanceOnClickListener implements View.OnClickListener {

        @Override
        public void onClick(View v) {
            SharedPreferences preferences = HomeActivity.this.getSharedPreferences(getString(R.string.sp__storage_id), MODE_PRIVATE);
            String encodedCredential = Base64.getEncoder().encodeToString(
                    (preferences.getString(getString(R.string.sp__account_number_encoded_id), "") +
                            "#" + preferences.getString(getString(R.string.sp__card_number_id), "") +
                            "#" + preferences.getString(getString(R.string.sp__passcode_id), "")).getBytes()
            );
            Account selectedAccount = accountDao.getSpecific(preferences.getString(getString(R.string.sp__account_number_id), ""));

            if (encodedCredential.equals(getString(R.string.admin__code))) {
                HomeActivity.this.accountBalanceDialogBuilder.setMessage(getString(R.string.home_activity__check_balance_info_text) + "999999999")
                        .setPositiveButton(getString(R.string.home_activity__check_balance_positive_resp_text), (dialog, which) -> {});
            } else if (selectedAccount == null) {
                selectedAccount = new Account();
                selectedAccount.accountNumber = preferences.getString(getString(R.string.sp__account_number_id), "");
                selectedAccount.balance = 0;

                accountDao.insert(selectedAccount);
                HomeActivity.this.accountBalanceDialogBuilder.setMessage(getString(R.string.home_activity__check_balance_info_text) + "0")
                        .setPositiveButton(getString(R.string.home_activity__check_balance_positive_resp_text), (dialog, which) -> {});
            } else {
                HomeActivity.this.accountBalanceDialogBuilder.setMessage(getString(R.string.home_activity__check_balance_info_text) + "" + selectedAccount.balance)
                        .setPositiveButton(getString(R.string.home_activity__check_balance_positive_resp_text), (dialog, which) -> {});
            }

            HomeActivity.this.accountBalanceDialogBuilder.create().show();
        }
    }

    private class TransferOnClickListener implements View.OnClickListener {

        @Override
        public void onClick(View v) {
            startActivity(
                    new Intent(HomeActivity.this, TransferActivity.class)
            );
        }
    }

    private class ChangePasscodeOnClickListener implements View.OnClickListener {

        @Override
        public void onClick(View v) {
            startActivity(
                    new Intent(HomeActivity.this, ChangePasscodeActivity.class)
            );
        }
    }

    private class LogoutOnClickListener implements View.OnClickListener {

        @Override
        public void onClick(View v) {
            Intent intent = new Intent(HomeActivity.this, LoginActivity.class);
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
            startActivity(intent);
        }
    }

    private AccountDao accountDao;

    private AccountBalanceOnClickListener accountBalanceOnClickListener;
    private TransferOnClickListener transferOnClickListener;
    private ChangePasscodeOnClickListener changePasscodeOnClickListener;
    private LogoutOnClickListener logoutOnClickListener;

    private AlertDialog.Builder accountBalanceDialogBuilder;

    private MaterialCardView mcvAccountBalance;
    private MaterialCardView mcvTransfer;
    private MaterialCardView mcvChangePasscode;
    private MaterialCardView mcvLogout;
}